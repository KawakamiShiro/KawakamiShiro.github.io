// ÊñáÁ´†ÁîüÊàêËÑöÊú¨
// Â∞Ü raw_article Êñá‰ª∂Â§π‰∏≠ÁöÑ markdown Êñá‰ª∂ËΩ¨Êç¢‰∏∫ HTML ÊñáÁ´†

const fs = require('fs');
const path = require('path');

// ÊñáÁ´†Ê®°Êùø
const articleTemplate = (title, meta, content) => `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title} - Kawakami Shiro</title>
    <style>
        :root {
            --radius: 18px;
            --shadow: 0 8px 30px rgba(0,0,0,0.06);
            --t: 360ms cubic-bezier(.2,.8,.2,1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: linear-gradient(180deg, var(--grad1) 0%, var(--grad2) 100%);
            min-height: 100vh;
            transition: background var(--t), color var(--t);
        }

        /* ‰∏ªÈ¢òÈÖçËâ≤ */
        body.day-theme {
            --grad1: #f9e8ea;
            --grad2: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --card: #ffffff;
            --accent: #ef4444;
        }

        body.night-theme {
            --grad1: #e8f0fb;  /* ‰∏ªÁïåÈù¢ÈªòËÆ§ËìùËâ≤Ê∏êÂèò */
            --grad2: #ffffff;
            --text: #1f2735;
            --muted: #5b6472;
            --card: #ffffff;
            --accent: #3b82f6;
        }

        .container {
            max-width: 860px;
            margin: 42px auto 96px;
            padding: 0 20px;
        }

        /* ÊñáÁ´†Â§¥ÈÉ® */
        .article-header {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 28px;
            border: 1px solid rgba(0,0,0,.06);
        }

        .article-title {
            font-size: 32px;
            font-weight: 800;
            color: var(--text);
            margin: 0 0 16px;
            line-height: 1.3;
        }

        .article-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--muted);
            flex-wrap: wrap;
        }

        .article-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* ÊñáÁ´†ÂÜÖÂÆπ */
        .article-content {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 28px;
            margin-bottom: 28px;
            border: 1px solid rgba(0,0,0,.06);
        }

        .article-content h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin: 32px 0 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(0,0,0,.06);
        }

        .article-content h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin: 24px 0 12px;
        }

        .article-content p {
            margin-bottom: 16px;
            line-height: 1.7;
            color: var(--text);
        }

        .article-content pre {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
            border: 1px solid rgba(0,0,0,.06);
        }

        .article-content code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            color: #e83e8c;
        }

        .article-content pre code {
            color: #333;
        }

        .article-content figure {
            margin: 24px 0;
            text-align: center;
        }

        .article-content img {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .article-content figcaption {
            margin-top: 8px;
            font-size: 14px;
            color: var(--muted);
            font-style: italic;
        }

        .article-content blockquote {
            border-left: 4px solid var(--accent);
            background: rgba(0,0,0,.02);
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        /* ÊñáÁ´†Â∫ïÈÉ® */
        .article-footer {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            border: 1px solid rgba(0,0,0,.06);
        }

        .article-navigation {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 16px;
        }

        .prev-article, .next-article {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            transition: color var(--t);
        }

        .prev-article:hover, .next-article:hover {
            color: var(--text);
        }

        .back-to-list {
            display: inline-block;
            color: var(--muted);
            text-decoration: none;
            font-weight: 500;
            transition: color var(--t);
        }

        .back-to-list:hover {
            color: var(--accent);
        }

        /* ËøîÂõû‰∏ªÈ°µÊåâÈíÆ */
        .back-home {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all var(--t);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .back-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 560px) {
            .container {
                padding: 16px;
            }
            
            .article-title {
                font-size: 24px;
            }
            
            .article-content {
                padding: 20px;
            }
            
            .article-navigation {
                flex-direction: column;
                align-items: center;
            }
            
            .back-home {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body class="night-theme">
    <div class="container">
        <!-- ÊñáÁ´†Â§¥ÈÉ® -->
        <header class="article-header">
            <h1 class="article-title">${title}</h1>
            <div class="article-meta">
                <span class="article-date">${meta.date}</span>
                <span class="article-category">${meta.category}</span>
                <span class="article-read-time">${meta.readTime}</span>
            </div>
            <div class="article-tags">
                ${meta.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>
        </header>

        <!-- ÊñáÁ´†ÂÜÖÂÆπ -->
        <article class="article-content">
            ${content}
        </article>

        <!-- ÊñáÁ´†Â∫ïÈÉ® -->
        <footer class="article-footer">
            <div class="article-navigation">
                <a href="${meta.prevArticle || '#'}" class="prev-article">‚Üê ‰∏ä‰∏ÄÁØáÔºö${meta.prevTitle || 'ÊöÇÊó†'}</a>
                <a href="${meta.nextArticle || '#'}" class="next-article">‰∏ã‰∏ÄÁØáÔºö${meta.nextTitle || 'ÊöÇÊó†'} ‚Üí</a>
            </div>
            <a href="../articles.html" class="back-to-list">‚Üê ËøîÂõûÊñáÁ´†ÂàóË°®</a>
        </footer>
    </div>

    <!-- ËøîÂõû‰∏ªÈ°µÊåâÈíÆ -->
    <button class="back-home" onclick="goHome()" title="ËøîÂõû‰∏ªÈ°µ">üè†</button>

    <script>
        // ËøîÂõû‰∏ªÈ°µ
        function goHome() {
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>`;

// Â∞Ü Markdown ËΩ¨Êç¢‰∏∫ HTML ÁöÑÂáΩÊï∞
function markdownToHtml(markdown) {
    let html = markdown;
    
    // ËΩ¨Êç¢Ê†áÈ¢ò
    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
    
    // ËΩ¨Êç¢ÊÆµËêΩ
    html = html.replace(/^(?!<[h|ul|ol|li|blockquote|pre|code]).*$/gim, '<p>$&</p>');
    
    // ËΩ¨Êç¢‰ª£Á†ÅÂùó
    html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
    
    // ËΩ¨Êç¢Ë°åÂÜÖ‰ª£Á†Å
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // ËΩ¨Êç¢ÂàóË°®
    html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
    html = html.replace(/^- (.*$)/gim, '<li>$1</li>');
    html = html.replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');
    
    // ËΩ¨Êç¢ÈìæÊé•
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    
    // ËΩ¨Êç¢ÂõæÁâá
    html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<figure><img src="$2" alt="$1"><figcaption>$1</figcaption></figure>');
    
    // ËΩ¨Êç¢ÂºïÁî®
    html = html.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');
    
    // ËΩ¨Êç¢Á≤ó‰ΩìÂíåÊñú‰Ωì
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Ê∏ÖÁêÜÁ©∫ÊÆµËêΩ
    html = html.replace(/<p><\/p>/g, '');
    
    return html;
}

// Ëß£Êûê YAML ÂÖÉÊï∞ÊçÆ
function parseYamlFrontMatter(content) {
    // Êõ¥ÂÆΩÊùæÁöÑ YAML ÂåπÈÖçÔºåÊîØÊåÅ‰∏çÂêåÁöÑÊç¢Ë°åÁ¨¶
    const yamlMatch = content.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n/);
    if (!yamlMatch) {
        console.log('‚ùå Êú™ÊâæÂà∞ YAML ÂÖÉÊï∞ÊçÆÂàÜÈöîÁ¨¶');
        return null;
    }
    
    const yamlContent = yamlMatch[1];
    const metadata = {};
    
    yamlContent.split('\n').forEach(line => {
        line = line.trim();
        if (line === '') return; // Ë∑≥ËøáÁ©∫Ë°å
        
        const colonIndex = line.indexOf(':');
        if (colonIndex > 0) {
            const key = line.substring(0, colonIndex).trim();
            let value = line.substring(colonIndex + 1).trim();
            
            // Â§ÑÁêÜÂ∏¶ÂºïÂè∑ÁöÑÂÄº
            if (value.startsWith('"') && value.endsWith('"')) {
                value = value.slice(1, -1);
            }
            
            // Â§ÑÁêÜÊï∞ÁªÑÔºàtagsÔºâ
            if (key === 'tags' && value.startsWith('[') && value.endsWith(']')) {
                value = value.slice(1, -1).split(',').map(tag => tag.trim().replace(/"/g, ''));
            }
            
            metadata[key] = value;
            console.log(`üìù Ëß£ÊûêÂÖÉÊï∞ÊçÆ: ${key} = ${JSON.stringify(value)}`);
        }
    });
    
    // È™åËØÅÂøÖË¶ÅÂ≠óÊÆµ
    if (!metadata.title) {
        console.log('‚ùå Áº∫Â∞ëÂøÖË¶ÅÂ≠óÊÆµ: title');
        return null;
    }
    
    console.log('‚úÖ ÂÖÉÊï∞ÊçÆËß£ÊûêÊàêÂäü:', Object.keys(metadata));
    
    return {
        metadata,
        content: content.substring(yamlMatch[0].length)
    };
}

// Êâ´Êèè raw_article ÁõÆÂΩïÔºåËá™Âä®ÂèëÁé∞ÊñáÁ´†
function scanArticles() {
    const rawArticleDir = path.join(__dirname, 'raw_article');
    const articles = [];
    
    if (!fs.existsSync(rawArticleDir)) {
        console.log('üìÅ raw_article ÁõÆÂΩï‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏≠...');
        fs.mkdirSync(rawArticleDir, { recursive: true });
        return articles;
    }
    
    // ÈÅçÂéÜÊâÄÊúâÂàÜÁ±ªÁõÆÂΩï
    const categories = fs.readdirSync(rawArticleDir, { withFileTypes: true })
        .filter(dirent => dirent.isDirectory())
        .map(dirent => dirent.name);
    
    categories.forEach(category => {
        const categoryDir = path.join(rawArticleDir, category);
        const files = fs.readdirSync(categoryDir)
            .filter(file => file.endsWith('.md'))
            .sort(); // ÊåâÊñá‰ª∂ÂêçÊéíÂ∫è
        
        files.forEach((file, index) => {
            const filePath = path.join(categoryDir, file);
            const content = fs.readFileSync(filePath, 'utf8');
            const parsed = parseYamlFrontMatter(content);
            
            if (parsed && parsed.metadata.title) {
                // ÁîüÊàêÊñá‰ª∂ÂêçÔºà‰∏â‰ΩçÊï∞Â≠óÁºñÂè∑Ôºâ
                const fileNumber = String(index + 1).padStart(3, '0');
                const htmlFile = `${fileNumber}.html`;
                
                articles.push({
                    ...parsed.metadata,
                    id: parseInt(parsed.metadata.id) || (index + 1),
                    file: htmlFile,
                    rawFile: `raw_article/${category}/${file}`,
                    category: category
                });
            } else {
                console.log(`‚ö†Ô∏è  Êñá‰ª∂ ${file} Áº∫Â∞ëÂøÖË¶ÅÁöÑÂÖÉÊï∞ÊçÆ`);
            }
        });
    });
    
    // Êåâ ID ÊéíÂ∫è
    articles.sort((a, b) => a.id - b.id);
    
    return articles;
}

// ‰∏ªÂáΩÊï∞ÔºöÁîüÊàêÊâÄÊúâÊñáÁ´†
function generateAllArticles() {
    console.log('üöÄ ÂºÄÂßãÁîüÊàêÊñáÁ´†...');
    
    // Á°Æ‰øùËæìÂá∫ÁõÆÂΩïÂ≠òÂú®
    const outputDir = path.join(__dirname, 'article');
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
        console.log('üìÅ ÂàõÂª∫ article ÁõÆÂΩï');
    }
    
    // Ëá™Âä®Êâ´ÊèèÊñáÁ´†
    const articles = scanArticles();
    
    if (articles.length === 0) {
        console.log('üìù Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïÊñáÁ´†Êñá‰ª∂');
        return;
    }
    
    console.log(`üìö ÂèëÁé∞ ${articles.length} ÁØáÊñáÁ´†`);
    
    // ÁîüÊàêÊØèÁØáÊñáÁ´†
    articles.forEach((article, index) => {
        const rawFilePath = path.join(__dirname, article.rawFile);
        const outputFilePath = path.join(outputDir, article.file);
        
        console.log(`üìù Â§ÑÁêÜÊñáÁ´†: ${article.title}`);
        
        // ËØªÂèñ Markdown ÂÜÖÂÆπ
        const markdownContent = fs.readFileSync(rawFilePath, 'utf8');
        const parsed = parseYamlFrontMatter(markdownContent);
        
        if (!parsed) {
            console.log(`‚ö†Ô∏è  Êñá‰ª∂ ${article.rawFile} Ê†ºÂºèÈîôËØØ`);
            return;
        }
        
        // ËΩ¨Êç¢‰∏∫ HTML
        const htmlContent = markdownToHtml(parsed.content);
        
        // ÂáÜÂ§áÂÖÉÊï∞ÊçÆ
        const meta = {
            date: article.date,
            category: getCategoryName(article.category),
            readTime: article.readTime,
            tags: article.tags,
            prevArticle: index > 0 ? articles[index - 1].file : '#',
            prevTitle: index > 0 ? articles[index - 1].title : '',
            nextArticle: index < articles.length - 1 ? articles[index + 1].file : '#',
            nextTitle: index < articles.length - 1 ? articles[index + 1].title : ''
        };
        
        // ÁîüÊàêÂÆåÊï¥ HTML
        const fullHtml = articleTemplate(article.title, meta, htmlContent);
        
        // ÂÜôÂÖ•Êñá‰ª∂
        fs.writeFileSync(outputFilePath, fullHtml, 'utf8');
        console.log(`‚úÖ ÁîüÊàêÊñáÁ´†: ${article.file}`);
    });
    
    // ÁîüÊàê articles.js ÈÖçÁΩÆÊñá‰ª∂
    generateArticlesConfig(articles);
    
    console.log('üéâ ÊñáÁ´†ÁîüÊàêÂÆåÊàêÔºÅ');
}

// Ëé∑ÂèñÂàÜÁ±ªÂêçÁß∞
function getCategoryName(categoryKey) {
    const categories = {
        tech: "ÊäÄÊúØÊñáÁ´†",
        food: "ÁæéÈ£üÁ†îÁ©∂",
        life: "ÁîüÊ¥ªÈöèÁ¨î",
        game: "Ê∏∏ÊàèÁõ∏ÂÖ≥"
    };
    return categories[categoryKey] || categoryKey;
}

// ÁîüÊàê articles.js ÈÖçÁΩÆÊñá‰ª∂
function generateArticlesConfig(articles) {
    console.log('üìù ÁîüÊàê articles.js ÈÖçÁΩÆÊñá‰ª∂...');
    
    // Êî∂ÈõÜÊâÄÊúâÂàÜÁ±ª
    const categories = {};
    articles.forEach(article => {
        if (!categories[article.category]) {
            const categoryNames = {
                tech: "ÊäÄÊúØÊñáÁ´†",
                food: "ÁæéÈ£üÁ†îÁ©∂",
                life: "ÁîüÊ¥ªÈöèÁ¨î",
                game: "Ê∏∏ÊàèÁõ∏ÂÖ≥"
            };
            
            categories[article.category] = {
                name: categoryNames[article.category] || article.category,
                description: `${categoryNames[article.category] || article.category}Áõ∏ÂÖ≥ÊñáÁ´†`,
                icon: getCategoryIcon(article.category)
            };
        }
    });
    
    // ÁîüÊàêÈÖçÁΩÆÊñá‰ª∂ÂÜÖÂÆπ
    const configContent = `// ÊñáÁ´†ÈÖçÁΩÆÊñá‰ª∂ - Ëá™Âä®ÁîüÊàêÔºåËØ∑ÂãøÊâãÂä®ÁºñËæë
// ‰øÆÊîπÂêé‰øùÂ≠òÊñá‰ª∂ÔºåÁΩëÁ´ô‰ºöËá™Âä®Êõ¥Êñ∞

const articlesConfig = {
  // ÊñáÁ´†ÂàÜÁ±ªÈÖçÁΩÆ
  categories: ${JSON.stringify(categories, null, 2)},

  // ÊñáÁ´†Êï∞ÊçÆ - ‰ªé raw_article Êñá‰ª∂Â§πÁöÑ markdown Êñá‰ª∂ÁîüÊàê
  articles: ${JSON.stringify(articles, null, 2)},

  // ÁΩëÁ´ô‰ø°ÊÅØ
  siteInfo: {
    title: "ÊñáÁ´†ÁõÆÂΩï - Kawakami Shiro",
    author: "Ê∏ä",
    avatar: "avatar_study.jpg",
    nickname: "USTC, baiyanchi1220@gmail.com",
    description: "ÊäÄÊúØÂàÜ‰∫´„ÄÅÁæéÈ£üÊé¢Á¥¢„ÄÅÁîüÊ¥ªÊÑüÊÇü„ÄÅÊ∏∏ÊàèÂà∂‰Ωú"
  },

  // ‰∏ªÈ¢òÈÖçÁΩÆ
  themes: {
    day: {
      grad1: '#f9e8ea',  // ÊµÖÁ∫¢Ëâ≤Ê∏êÂèò
      grad2: '#ffffff',
      text: '#1f2937',
      muted: '#6b7280',
      card: '#ffffff',
      accent: '#ef4444'
    },
    night: {
      grad1: '#e8f0fb',  // ÊµÖËìùËâ≤Ê∏êÂèòÔºà‰∏ªÁïåÈù¢ÈªòËÆ§Ôºâ
      grad2: '#ffffff',
      text: '#1f2735',
      muted: '#5b6472',
      card: '#ffffff',
      accent: '#3b82f6'
    }
  }
};

// ÂØºÂá∫ÈÖçÁΩÆÔºàÂ¶ÇÊûú‰ΩøÁî®Ê®°ÂùóÁ≥ªÁªüÔºâ
if (typeof module !== 'undefined' && module.exports) {
  module.exports = articlesConfig;
}`;
    
    // ÂÜôÂÖ•ÈÖçÁΩÆÊñá‰ª∂
    const configPath = path.join(__dirname, 'articles.js');
    fs.writeFileSync(configPath, configContent, 'utf8');
    console.log('‚úÖ ÁîüÊàê articles.js ÈÖçÁΩÆÊñá‰ª∂');
}

// Ëé∑ÂèñÂàÜÁ±ªÂõæÊ†á
function getCategoryIcon(category) {
    const icons = {
        tech: "üíª",
        food: "üçú",
        life: "üìù",
        game: "üéÆ"
    };
    return icons[category] || "üìÑ";
}

// Â¶ÇÊûúÁõ¥Êé•ËøêË°åÊ≠§ËÑöÊú¨
if (require.main === module) {
    generateAllArticles();
}
